name: Build & Release Universal APK and EXE

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch: # Allows manual trigger

permissions:
  contents: write

jobs:
  # ======================================================
  # JOB 1: Build Android Universal APK
  # ======================================================
  android-build:
    name: Build Android APK (SDK 36)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
      
      - name: Install Android SDK 36 and Build Tools
        run: sdkmanager "platforms;android-36" "build-tools;36.0.0-rc1" # Installing 36 specifically as requested

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # This decodes the secret keystore into a physical file
      - name: Decode Keystore
        env:
          KEYSTORE_FILE: ${{ secrets.KEYSTORE_FILE }}
        run: |
          echo "$KEYSTORE_FILE" | base64 --decode > app/release.keystore

      # Build the Universal APK
      - name: Build Release APK
        run: ./gradlew assembleRelease
        
      # Signs the APK using the keystore file we decoded + secrets
      - name: Sign APK
        uses: r0adkll/sign-android-release@v1
        id: sign_app
        with:
          releaseDirectory: app/build/outputs/apk/release
          signingKeyBase64: ${{ secrets.KEYSTORE_FILE }}
          alias: ${{ secrets.KEY_ALIAS }}
          keyStorePassword: ${{ secrets.KEYSTORE_PASSWORD }}
          keyPassword: ${{ secrets.KEY_PASSWORD }}
        
      # Upload to Release Page
      - name: Upload APK to Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: ${{ steps.sign_app.outputs.signedReleaseFile }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ======================================================
  # JOB 2: Build Windows Python EXE
  # ======================================================
  windows-exe-build:
    name: Build Windows EXE
    runs-on: windows-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11' 
          cache: 'pip'

      - name: Install Dependencies
        # Installing dependencies based on your imports in main.py
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller fastapi uvicorn pyautogui pyperclip pystray Pillow screen_brightness_control python-multipart requests

      - name: Build EXE with PyInstaller
        # Using the flags from your comment in the screenshot + standard strict flags
        run: |
          cd app/python
          pyinstaller --noconsole --onefile --name "RemoteDeckServer" --hidden-import=python_multipart --hidden-import=pystray --hidden-import=PIL --hidden-import=uvicorn main.py

      - name: Upload EXE to Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: app/python/dist/RemoteDeckServer.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
