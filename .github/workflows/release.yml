name: Build & Release Universal APK and EXE

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # ======================================================
  # JOB 1: Build Android Universal APK
  # ======================================================
  android-build:
    name: Build Android APK (SDK 36)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
      
      - name: Install Android SDK 36 and Build Tools
        run: sdkmanager "platforms;android-36" "build-tools;36.0.0-rc1"

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Decode Keystore
        env:
          KEYSTORE_FILE: ${{ secrets.KEYSTORE_FILE }}
        run: |
          echo "$KEYSTORE_FILE" | base64 --decode > app/release.keystore

      - name: Build Release APK
        env:
          BUILD_VERSION_NAME: ${{ github.ref_name }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: ./gradlew assembleRelease
        
      - name: Upload APK to Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: app/build/outputs/apk/release/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ======================================================
  # JOB 2: Build Windows Python EXE & ZIP
  # ======================================================
  windows-exe-build:
    name: Build Windows EXE
    runs-on: windows-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller fastapi uvicorn pyautogui pyperclip pystray Pillow screen_brightness_control python-multipart requests

      - name: Build EXE with PyInstaller
        run: |
          cd python
          pyinstaller --noconsole --onefile --name "RemoteDeckServer" --hidden-import=python_multipart --hidden-import=pystray --hidden-import=PIL --hidden-import=uvicorn main.py

      - name: Zip the Executable
        shell: pwsh
        run: |
          Compress-Archive -Path "python/dist/RemoteDeckServer.exe" -DestinationPath "python/dist/RemoteDeckServer-Windows.zip"

      - name: Upload Zip to Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: python/dist/RemoteDeckServer-Windows.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
